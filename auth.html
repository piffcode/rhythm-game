<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Rhythm Game - Authentication</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1db954, #191414);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .auth-container {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        
        .logo {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #1db954;
        }
        
        .subtitle {
            font-size: 1.1em;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .auth-button {
            background: #1db954;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .auth-button:hover:not(:disabled) {
            background: #1ed760;
            transform: translateY(-2px);
        }
        
        .auth-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }
        
        .message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9em;
            line-height: 1.4;
            display: none;
        }
        
        .message.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            display: block;
        }
        
        .message.success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #1db954;
            color: #1db954;
            display: block;
        }
        
        .message.warn {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #ffc107;
            display: block;
        }
        
        .loading {
            display: none;
            margin-top: 20px;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #1db954;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .premium-note {
            font-size: 0.85em;
            opacity: 0.7;
            margin-top: 15px;
        }
        
        .retry-button {
            background: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s ease;
        }
        
        .retry-button:hover {
            background: #444;
        }
        
        .debug-info {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            padding: 10px;
            margin-top: 20px;
            border-radius: 6px;
            font-size: 0.8em;
            font-family: monospace;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-toggle {
            background: transparent;
            border: 1px solid #666;
            color: #666;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.7em;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .debug-toggle:hover {
            border-color: #999;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">ðŸŽµ Rhythm</div>
        <div class="subtitle">Connect your Spotify account to start playing</div>
        
        <button id="authButton" class="auth-button">Connect Spotify</button>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Authenticating...</p>
        </div>
        
        <div id="message" class="message"></div>
        
        <div class="premium-note">
            Spotify Premium required for playback control
        </div>
        
        <button id="debugToggle" class="debug-toggle">Show Debug Info</button>
        <div id="debugInfo" class="debug-info"></div>
    </div>

    <script>
        // Enhanced configuration with better error handling
        const CONFIG = (() => {
            const currentHost = window.location.origin;
            const isLocal = currentHost.includes('localhost') || currentHost.includes('127.0.0.1') || currentHost.includes('192.168.');
            
            // Production host - your actual Vercel domain
            const PROD_HOST = 'https://rhythm-game-phi.vercel.app';
            
            const config = {
                IS_LOCAL: isLocal,
                HOST: isLocal ? currentHost : PROD_HOST,
                
                // Spotify App Credentials
                CLIENT_ID: '07f4566e6a2a4428ac68ec86d73adf34',
                
                // Scopes required for the game
                SCOPES: [
                    'user-read-private',
                    'user-read-email', 
                    'user-read-playback-state',
                    'user-modify-playbook-state',
                    'streaming',
                    'playlist-modify-private',
                    'user-library-modify'
                ]
            };
            
            // Derive URLs
            config.AUTH_REDIRECT_URI = `${config.HOST}/auth.html`;
            config.GAME_URL = `${config.HOST}/rhythm.html`;
            config.INDEX_URL = `${config.HOST}/index.html`;
            
            return config;
        })();

        class SpotifyAuth {
            constructor() {
                this.debugLog = [];
                this.init();
            }
            
            log(message, data = null) {
                const timestamp = new Date().toISOString();
                const logEntry = `[${timestamp}] ${message}`;
                console.log(logEntry, data || '');
                this.debugLog.push(logEntry + (data ? ` ${JSON.stringify(data)}` : ''));
                this.updateDebugDisplay();
            }
            
            updateDebugDisplay() {
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) {
                    debugInfo.textContent = this.debugLog.join('\n');
                    debugInfo.scrollTop = debugInfo.scrollHeight;
                }
            }
            
            init() {
                this.log('SpotifyAuth initializing');
                
                // Enhanced environment check
                this.checkEnvironment();
                
                // Check if returning from OAuth
                if (window.location.search) {
                    this.log('URL has search params, handling callback');
                    this.handleCallback();
                } else {
                    this.log('No search params, setting up auth button');
                    this.setupAuthButton();
                }
                
                // Setup debug toggle
                this.setupDebugToggle();
            }
            
            checkEnvironment() {
                const issues = [];
                
                // Check HTTPS requirement
                if (location.protocol !== 'https:' && !CONFIG.IS_LOCAL) {
                    issues.push('HTTPS required for production');
                }
                
                // Check crypto API
                if (!window.crypto || !window.crypto.subtle) {
                    issues.push('Crypto API not available');
                }
                
                // Check client ID
                if (!CONFIG.CLIENT_ID || CONFIG.CLIENT_ID === 'your_client_id_here') {
                    issues.push('Invalid CLIENT_ID configuration');
                }
                
                // Check redirect URI
                try {
                    new URL(CONFIG.AUTH_REDIRECT_URI);
                } catch (e) {
                    issues.push('Invalid redirect URI');
                }
                
                this.log('Environment check', {
                    host: CONFIG.HOST,
                    isLocal: CONFIG.IS_LOCAL,
                    protocol: location.protocol,
                    clientId: CONFIG.CLIENT_ID.substring(0, 8) + '...',
                    redirectUri: CONFIG.AUTH_REDIRECT_URI,
                    issues: issues
                });
                
                if (issues.length > 0) {
                    this.showMessage(`Configuration issues: ${issues.join(', ')}`, 'error', true);
                }
            }
            
            setupAuthButton() {
                const authButton = document.getElementById('authButton');
                
                // Remove any existing listeners
                authButton.replaceWith(authButton.cloneNode(true));
                const newButton = document.getElementById('authButton');
                
                newButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.log('Auth button clicked');
                    this.startAuth();
                });
                
                this.log('Auth button setup complete');
            }
            
            setupDebugToggle() {
                const debugToggle = document.getElementById('debugToggle');
                const debugInfo = document.getElementById('debugInfo');
                
                debugToggle.addEventListener('click', () => {
                    const isVisible = debugInfo.style.display === 'block';
                    debugInfo.style.display = isVisible ? 'none' : 'block';
                    debugToggle.textContent = isVisible ? 'Show Debug Info' : 'Hide Debug Info';
                });
            }
            
            showMessage(text, type = 'error', showRetry = false) {
                const messageEl = document.getElementById('message');
                let messageHtml = text;
                
                if (showRetry) {
                    messageHtml += '<br><button class="retry-button" onclick="location.reload()">Try Again</button>';
                }
                
                messageEl.innerHTML = messageHtml;
                messageEl.className = `message ${type}`;
                
                this.log(`Message shown: ${type}`, text);
            }
            
            showLoading(show = true) {
                const loading = document.getElementById('loading');
                const authButton = document.getElementById('authButton');
                
                loading.style.display = show ? 'block' : 'none';
                authButton.disabled = show;
                
                if (show) {
                    authButton.textContent = 'Connecting...';
                } else {
                    authButton.textContent = 'Connect Spotify';
                }
                
                this.log(`Loading state: ${show}`);
            }
            
            // PKCE helpers with better error handling
            generateCodeVerifier() {
                try {
                    const array = new Uint8Array(32);
                    crypto.getRandomValues(array);
                    return btoa(String.fromCharCode(...array))
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_')
                        .replace(/=/g, '');
                } catch (error) {
                    this.log('Failed to generate code verifier', error.message);
                    // Fallback method
                    return Math.random().toString(36).substring(2, 15) + 
                           Math.random().toString(36).substring(2, 15);
                }
            }
            
            async generateCodeChallenge(verifier) {
                try {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(verifier);
                    const digest = await crypto.subtle.digest('SHA-256', data);
                    return btoa(String.fromCharCode(...new Uint8Array(digest)))
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_')
                        .replace(/=/g, '');
                } catch (error) {
                    this.log('Failed to generate code challenge', error.message);
                    // Fallback: return verifier (less secure but works)
                    return verifier;
                }
            }
            
            generateState() {
                try {
                    const array = new Uint8Array(16);
                    crypto.getRandomValues(array);
                    return btoa(String.fromCharCode(...array));
                } catch (error) {
                    this.log('Failed to generate state', error.message);
                    return Math.random().toString(36).substring(2, 15);
                }
            }
            
            async startAuth() {
                try {
                    this.log('Starting authentication process');
                    this.showLoading(true);
                    
                    // Check crypto API availability
                    if (!window.crypto) {
                        throw new Error('Crypto API not available. Please use a modern browser (Chrome, Firefox, Safari, Edge).');
                    }
                    
                    // Preserve country parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    const country = urlParams.get('country');
                    this.log('Country parameter', country);
                    
                    // Generate PKCE parameters
                    this.log('Generating PKCE parameters');
                    const codeVerifier = this.generateCodeVerifier();
                    const codeChallenge = await this.generateCodeChallenge(codeVerifier);
                    const state = this.generateState();
                    
                    this.log('PKCE parameters generated', {
                        verifierLength: codeVerifier.length,
                        challengeLength: codeChallenge.length,
                        stateLength: state.length
                    });
                    
                    // Store PKCE parameters and country
                    sessionStorage.setItem('code_verifier', codeVerifier);
                    sessionStorage.setItem('oauth_state', state);
                    if (country) {
                        sessionStorage.setItem('auth_country', country);
                    }
                    
                    this.log('Stored session data');
                    
                    // Build authorization URL
                    const params = new URLSearchParams({
                        client_id: CONFIG.CLIENT_ID,
                        response_type: 'code',
                        redirect_uri: CONFIG.AUTH_REDIRECT_URI,
                        code_challenge_method: 'S256',
                        code_challenge: codeChallenge,
                        state: state,
                        scope: CONFIG.SCOPES.join(' ')
                    });
                    
                    const authUrl = `https://accounts.spotify.com/authorize?${params}`;
                    
                    this.log('Authorization URL built', {
                        url: authUrl.substring(0, 100) + '...',
                        clientId: CONFIG.CLIENT_ID.substring(0, 8) + '...',
                        redirectUri: CONFIG.AUTH_REDIRECT_URI,
                        scopes: CONFIG.SCOPES.length
                    });
                    
                    // Add a delay to show loading state
                    setTimeout(() => {
                        this.log('Redirecting to Spotify authorization');
                        window.location.href = authUrl;
                    }, 500);
                    
                } catch (error) {
                    this.log('Auth setup error', error.message);
                    console.error('Auth setup error:', error);
                    this.showMessage(`Authentication setup failed: ${error.message}`, 'error', true);
                    this.showLoading(false);
                }
            }
            
            async handleCallback() {
                try {
                    this.log('Handling OAuth callback');
                    this.showLoading(true);
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const code = urlParams.get('code');
                    const state = urlParams.get('state');
                    const error = urlParams.get('error');
                    const errorDescription = urlParams.get('error_description');
                    
                    this.log('Callback parameters', {
                        hasCode: !!code,
                        hasState: !!state,
                        error: error,
                        errorDescription: errorDescription
                    });
                    
                    // Handle OAuth errors with better messaging
                    if (error) {
                        let errorMessage = 'Authentication failed';
                        
                        switch (error) {
                            case 'access_denied':
                                errorMessage = 'Authorization was cancelled. You need to grant access to use the game.';
                                break;
                            case 'invalid_client':
                                errorMessage = 'Application configuration error. Please contact support.';
                                break;
                            case 'invalid_request':
                                errorMessage = 'Invalid authentication request. Please try again.';
                                break;
                            case 'server_error':
                                errorMessage = 'Spotify server error. Please try again in a few moments.';
                                break;
                            default:
                                errorMessage = errorDescription || `Authentication error: ${error}`;
                        }
                        
                        this.log('OAuth error', errorMessage);
                        this.showMessage(errorMessage, 'error', true);
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    // Validate state parameter
                    const storedState = sessionStorage.getItem('oauth_state');
                    if (!state || state !== storedState) {
                        this.log('State validation failed', {
                            receivedState: state?.substring(0, 10) + '...',
                            storedState: storedState?.substring(0, 10) + '...'
                        });
                        this.showMessage('Security validation failed. This may be a security issue or session timeout. Please start over.', 'error', true);
                        this.clearSession();
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    // Check for authorization code
                    if (!code) {
                        this.log('No authorization code received');
                        this.showMessage('No authorization code received from Spotify. Please try again.', 'error', true);
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    // Get stored code verifier
                    const codeVerifier = sessionStorage.getItem('code_verifier');
                    if (!codeVerifier) {
                        this.log('No code verifier found');
                        this.showMessage('Authentication session expired. Please start the login process again.', 'error', true);
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    this.log('Validation passed, exchanging code for tokens');
                    
                    // Exchange code for tokens
                    await this.exchangeCodeForTokens(code, codeVerifier);
                    
                } catch (error) {
                    this.log('Callback handling error', error.message);
                    console.error('Callback handling error:', error);
                    this.showMessage(`Authentication processing failed: ${error.message}`, 'error', true);
                    this.showLoading(false);
                }
            }
            
            async exchangeCodeForTokens(code, codeVerifier) {
                try {
                    this.log('Making token exchange request');
                    
                    const requestBody = new URLSearchParams({
                        client_id: CONFIG.CLIENT_ID,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: CONFIG.AUTH_REDIRECT_URI,
                        code_verifier: codeVerifier
                    });
                    
                    this.log('Token request body prepared');
                    
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: requestBody
                    });
                    
                    this.log('Token response received', {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        let errorMessage = 'Failed to complete authentication';
                        
                        this.log('Token exchange failed', {
                            status: response.status,
                            error: errorData.error,
                            description: errorData.error_description
                        });
                        
                        switch (errorData.error) {
                            case 'invalid_grant':
                                errorMessage = 'Authorization code expired. Please try logging in again.';
                                break;
                            case 'invalid_client':
                                errorMessage = 'Application configuration error. Please contact support.';
                                break;
                            case 'invalid_request':
                                errorMessage = 'Authentication request was invalid. Please try again.';
                                break;
                            default:
                                errorMessage = errorData.error_description || `Authentication error: ${errorData.error || response.status}`;
                        }
                        
                        throw new Error(errorMessage);
                    }
                    
                    const tokens = await response.json();
                    
                    this.log('Tokens received successfully', {
                        hasAccessToken: !!tokens.access_token,
                        hasRefreshToken: !!tokens.refresh_token,
                        expiresIn: tokens.expires_in
                    });
                    
                    // Validate token response
                    if (!tokens.access_token) {
                        throw new Error('Invalid token response from Spotify');
                    }
                    
                    // Calculate expiration time
                    const expiresAt = Date.now() + (tokens.expires_in * 1000);
                    
                    // Store tokens securely
                    sessionStorage.setItem('access_token', tokens.access_token);
                    if (tokens.refresh_token) {
                        sessionStorage.setItem('refresh_token', tokens.refresh_token);
                    }
                    sessionStorage.setItem('expires_at', expiresAt.toString());
                    
                    // Generate bootstrap nonce for additional security
                    const bootstrapNonce = this.generateState();
                    sessionStorage.setItem('bootstrap_nonce', bootstrapNonce);
                    
                    // Clean up OAuth session data
                    sessionStorage.removeItem('code_verifier');
                    sessionStorage.removeItem('oauth_state');
                    
                    // Prepare navigation with preserved country
                    const country = sessionStorage.getItem('auth_country');
                    sessionStorage.removeItem('auth_country');
                    
                    let gameUrl = `${CONFIG.GAME_URL}?bootstrap=${bootstrapNonce}`;
                    if (country) {
                        gameUrl += `&country=${encodeURIComponent(country)}`;
                    }
                    
                    this.log('Preparing redirect to game', {
                        gameUrl: gameUrl.substring(0, 50) + '...'
                    });
                    
                    this.showMessage('Authentication successful! Redirecting to game...', 'success');
                    
                    // Navigate to game with a slight delay for user feedback
                    setTimeout(() => {
                        this.log('Redirecting to game');
                        window.location.href = gameUrl;
                    }, 1500);
                    
                } catch (error) {
                    this.log('Token exchange error', error.message);
                    console.error('Token exchange error:', error);
                    this.showMessage(error.message || 'Failed to complete authentication', 'error', true);
                    this.clearSession();
                    this.showLoading(false);
                }
            }
            
            clearSession() {
                this.log('Clearing session storage');
                sessionStorage.removeItem('code_verifier');
                sessionStorage.removeItem('oauth_state');
                sessionStorage.removeItem('auth_country');
                sessionStorage.removeItem('access_token');
                sessionStorage.removeItem('refresh_token');
                sessionStorage.removeItem('expires_at');
                sessionStorage.removeItem('bootstrap_nonce');
            }
            
            clearCallbackUrl() {
                this.log('Clearing callback URL');
                const url = new URL(window.location);
                url.search = '';
                window.history.replaceState({}, document.title, url.toString());
            }
        }

        // Initialize the auth system with better error handling
        document.addEventListener('DOMContentLoaded', () => {
            try {
                new SpotifyAuth();
            } catch (error) {
                console.error('Failed to initialize auth:', error);
                document.getElementById('message').innerHTML = 
                    `<div class="message error">Failed to initialize: ${error.message}<br><button class="retry-button" onclick="location.reload()">Reload Page</button></div>`;
            }
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            const messageEl = document.getElementById('message');
            if (messageEl && !messageEl.innerHTML) {
                messageEl.innerHTML = `<div class="message error">JavaScript error: ${event.error?.message || 'Unknown error'}<br><button class="retry-button" onclick="location.reload()">Reload Page</button></div>`;
            }
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            const messageEl = document.getElementById('message');
            if (messageEl && !messageEl.innerHTML) {
                messageEl.innerHTML = `<div class="message error">Promise error: ${event.reason?.message || 'Unknown error'}<br><button class="retry-button" onclick="location.reload()">Reload Page</button></div>`;
            }
        });
    </script>
</body>
</html>