<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Rhythm Game - Authentication</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1db954, #191414);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .auth-container {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        
        .logo {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #1db954;
        }
        
        .subtitle {
            font-size: 1.1em;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .auth-button {
            background: #1db954;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .auth-button:hover {
            background: #1ed760;
            transform: translateY(-2px);
        }
        
        .auth-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .message.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
        }
        
        .message.success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #1db954;
            color: #1db954;
        }
        
        .loading {
            display: none;
            margin-top: 20px;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #1db954;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .premium-note {
            font-size: 0.85em;
            opacity: 0.7;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">ðŸŽµ Rhythm</div>
        <div class="subtitle">Connect your Spotify account to start playing</div>
        
        <button id="authButton" class="auth-button">Connect Spotify</button>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Authenticating...</p>
        </div>
        
        <div id="message"></div>
        
        <div class="premium-note">
            Spotify Premium required for playback control
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        class SpotifyAuth {
            constructor() {
                this.init();
            }
            
            init() {
                // Check if returning from OAuth
                if (window.location.search) {
                    this.handleCallback();
                } else {
                    this.setupAuthButton();
                }
            }
            
            setupAuthButton() {
                const authButton = document.getElementById('authButton');
                authButton.addEventListener('click', () => this.startAuth());
            }
            
            showMessage(text, type = 'error') {
                const messageEl = document.getElementById('message');
                messageEl.textContent = text;
                messageEl.className = `message ${type}`;
            }
            
            showLoading(show = true) {
                const loading = document.getElementById('loading');
                const authButton = document.getElementById('authButton');
                
                loading.style.display = show ? 'block' : 'none';
                authButton.disabled = show;
            }
            
            // PKCE helpers
            generateCodeVerifier() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return btoa(String.fromCharCode(...array))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
            }
            
            async generateCodeChallenge(verifier) {
                const encoder = new TextEncoder();
                const data = encoder.encode(verifier);
                const digest = await crypto.subtle.digest('SHA-256', data);
                return btoa(String.fromCharCode(...new Uint8Array(digest)))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
            }
            
            generateState() {
                const array = new Uint8Array(16);
                crypto.getRandomValues(array);
                return btoa(String.fromCharCode(...array));
            }
            
            async startAuth() {
                try {
                    this.showLoading(true);
                    
                    // Preserve country parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    const country = urlParams.get('country');
                    
                    // Generate PKCE parameters
                    const codeVerifier = this.generateCodeVerifier();
                    const codeChallenge = await this.generateCodeChallenge(codeVerifier);
                    const state = this.generateState();
                    
                    // Store PKCE parameters and country
                    sessionStorage.setItem('code_verifier', codeVerifier);
                    sessionStorage.setItem('oauth_state', state);
                    if (country) {
                        sessionStorage.setItem('auth_country', country);
                    }
                    
                    // Build authorization URL
                    const params = new URLSearchParams({
                        client_id: CONFIG.CLIENT_ID,
                        response_type: 'code',
                        redirect_uri: CONFIG.AUTH_REDIRECT_URI,
                        code_challenge_method: 'S256',
                        code_challenge: codeChallenge,
                        state: state,
                        scope: CONFIG.SCOPES.join(' ')
                    });
                    
                    const authUrl = `https://accounts.spotify.com/authorize?${params}`;
                    window.location.href = authUrl;
                    
                } catch (error) {
                    console.error('Auth setup error:', error);
                    this.showMessage('Failed to start authentication. Please try again.');
                    this.showLoading(false);
                }
            }
            
            async handleCallback() {
                try {
                    this.showLoading(true);
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const code = urlParams.get('code');
                    const state = urlParams.get('state');
                    const error = urlParams.get('error');
                    
                    // Handle OAuth errors
                    if (error) {
                        if (error === 'access_denied') {
                            this.showMessage('Authorization cancelled. Please try again to play.');
                        } else {
                            this.showMessage(`Authentication failed: ${error}`);
                        }
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    // Validate state
                    const storedState = sessionStorage.getItem('oauth_state');
                    if (!state || state !== storedState) {
                        this.showMessage('Security check failed. Please start over.');
                        this.clearSession();
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    // Get code verifier
                    const codeVerifier = sessionStorage.getItem('code_verifier');
                    if (!codeVerifier) {
                        this.showMessage('Session expired. Please start over.');
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    if (!code) {
                        this.showMessage('No authorization code received. Please try again.');
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    // Exchange code for tokens
                    await this.exchangeCodeForTokens(code, codeVerifier);
                    
                } catch (error) {
                    console.error('Callback handling error:', error);
                    this.showMessage('Authentication failed. Please try again.');
                    this.showLoading(false);
                }
            }
            
            async exchangeCodeForTokens(code, codeVerifier) {
                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            client_id: CONFIG.CLIENT_ID,
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: CONFIG.AUTH_REDIRECT_URI,
                            code_verifier: codeVerifier
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Token exchange failed: ${errorData.error_description || errorData.error}`);
                    }
                    
                    const tokens = await response.json();
                    
                    // Calculate expiration time
                    const expiresAt = Date.now() + (tokens.expires_in * 1000);
                    
                    // Store tokens
                    sessionStorage.setItem('access_token', tokens.access_token);
                    if (tokens.refresh_token) {
                        sessionStorage.setItem('refresh_token', tokens.refresh_token);
                    }
                    sessionStorage.setItem('expires_at', expiresAt.toString());
                    
                    // Generate bootstrap nonce
                    const bootstrapNonce = this.generateState();
                    sessionStorage.setItem('bootstrap_nonce', bootstrapNonce);
                    
                    // Clean up OAuth session data
                    sessionStorage.removeItem('code_verifier');
                    sessionStorage.removeItem('oauth_state');
                    
                    // Prepare navigation with preserved country
                    const country = sessionStorage.getItem('auth_country');
                    sessionStorage.removeItem('auth_country');
                    
                    let gameUrl = `${CONFIG.GAME_URL}?bootstrap=${bootstrapNonce}`;
                    if (country) {
                        gameUrl += `&country=${encodeURIComponent(country)}`;
                    }
                    
                    this.showMessage('Success! Redirecting to game...', 'success');
                    
                    // Navigate to game
                    setTimeout(() => {
                        window.location.href = gameUrl;
                    }, 1000);
                    
                } catch (error) {
                    console.error('Token exchange error:', error);
                    this.showMessage(error.message || 'Failed to complete authentication');
                    this.clearSession();
                    this.showLoading(false);
                }
            }
            
            clearSession() {
                sessionStorage.removeItem('code_verifier');
                sessionStorage.removeItem('oauth_state');
                sessionStorage.removeItem('auth_country');
            }
            
            clearCallbackUrl() {
                // Clear URL parameters without reload
                window.history.replaceState({}, document.title, window.location.pathname);
                this.showLoading(false);
            }
        }
        
        // Initialize authentication
        new SpotifyAuth();
    </script>
</body>
</html>