<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Rhythm Game - Authentication</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://accounts.spotify.com; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1db954, #191414);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .auth-container {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        
        .logo {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #1db954;
        }
        
        .subtitle {
            font-size: 1.1em;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .auth-button {
            background: #1db954;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .auth-button:hover {
            background: #1ed760;
            transform: translateY(-2px);
        }
        
        .auth-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .message.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
        }
        
        .message.success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #1db954;
            color: #1db954;
        }
        
        .loading {
            display: none;
            margin-top: 20px;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #1db954;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .premium-note {
            font-size: 0.85em;
            opacity: 0.7;
            margin-top: 15px;
        }
        
        .retry-button {
            background: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s ease;
        }
        
        .retry-button:hover {
            background: #444;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">ðŸŽµ Rhythm</div>
        <div class="subtitle">Connect your Spotify account to start playing</div>
        
        <button id="authButton" class="auth-button">Connect Spotify</button>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Authenticating...</p>
        </div>
        
        <div id="message"></div>
        
        <div class="premium-note">
            Spotify Premium required for playback control
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        class SpotifyAuth {
            constructor() {
                this.init();
            }
            
            init() {
                // Check if returning from OAuth
                if (window.location.search) {
                    this.handleCallback();
                } else {
                    this.setupAuthButton();
                }
            }
            
            setupAuthButton() {
                const authButton = document.getElementById('authButton');
                authButton.addEventListener('click', () => this.startAuth());
            }
            
            showMessage(text, type = 'error', showRetry = false) {
                const messageEl = document.getElementById('message');
                let messageHtml = text;
                
                if (showRetry) {
                    messageHtml += '<br><button class="retry-button" onclick="location.reload()">Try Again</button>';
                }
                
                messageEl.innerHTML = messageHtml;
                messageEl.className = `message ${type}`;
            }
            
            showLoading(show = true) {
                const loading = document.getElementById('loading');
                const authButton = document.getElementById('authButton');
                
                loading.style.display = show ? 'block' : 'none';
                authButton.disabled = show;
            }
            
            // PKCE helpers
            generateCodeVerifier() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return btoa(String.fromCharCode(...array))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
            }
            
            async generateCodeChallenge(verifier) {
                const encoder = new TextEncoder();
                const data = encoder.encode(verifier);
                const digest = await crypto.subtle.digest('SHA-256', data);
                return btoa(String.fromCharCode(...new Uint8Array(digest)))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
            }
            
            generateState() {
                const array = new Uint8Array(16);
                crypto.getRandomValues(array);
                return btoa(String.fromCharCode(...array));
            }
            
            async startAuth() {
                try {
                    this.showLoading(true);
                    
                    // Check if crypto API is available
                    if (!window.crypto || !window.crypto.subtle) {
                        throw new Error('This browser does not support secure authentication. Please use a modern browser.');
                    }
                    
                    // Preserve country parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    const country = urlParams.get('country');
                    
                    // Generate PKCE parameters
                    const codeVerifier = this.generateCodeVerifier();
                    const codeChallenge = await this.generateCodeChallenge(codeVerifier);
                    const state = this.generateState();
                    
                    // Store PKCE parameters and country
                    sessionStorage.setItem('code_verifier', codeVerifier);
                    sessionStorage.setItem('oauth_state', state);
                    if (country) {
                        sessionStorage.setItem('auth_country', country);
                    }
                    
                    // Build authorization URL
                    const params = new URLSearchParams({
                        client_id: CONFIG.CLIENT_ID,
                        response_type: 'code',
                        redirect_uri: CONFIG.AUTH_REDIRECT_URI,
                        code_challenge_method: 'S256',
                        code_challenge: codeChallenge,
                        state: state,
                        scope: CONFIG.SCOPES.join(' ')
                    });
                    
                    const authUrl = `https://accounts.spotify.com/authorize?${params}`;
                    window.location.href = authUrl;
                    
                } catch (error) {
                    console.error('Auth setup error:', error);
                    this.showMessage(`Authentication setup failed: ${error.message}`, 'error', true);
                    this.showLoading(false);
                }
            }
            
            async handleCallback() {
                try {
                    this.showLoading(true);
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const code = urlParams.get('code');
                    const state = urlParams.get('state');
                    const error = urlParams.get('error');
                    const errorDescription = urlParams.get('error_description');
                    
                    // Handle OAuth errors with better messaging
                    if (error) {
                        let errorMessage = 'Authentication failed';
                        
                        switch (error) {
                            case 'access_denied':
                                errorMessage = 'Authorization was cancelled. You need to grant access to use the game.';
                                break;
                            case 'invalid_client':
                                errorMessage = 'Application configuration error. Please contact support.';
                                break;
                            case 'invalid_request':
                                errorMessage = 'Invalid authentication request. Please try again.';
                                break;
                            case 'server_error':
                                errorMessage = 'Spotify server error. Please try again in a few moments.';
                                break;
                            default:
                                errorMessage = errorDescription || `Authentication error: ${error}`;
                        }
                        
                        this.showMessage(errorMessage, 'error', true);
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    // Validate state parameter
                    const storedState = sessionStorage.getItem('oauth_state');
                    if (!state || state !== storedState) {
                        this.showMessage('Security validation failed. This may be a security issue or session timeout. Please start over.', 'error', true);
                        this.clearSession();
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    // Check for authorization code
                    if (!code) {
                        this.showMessage('No authorization code received from Spotify. Please try again.', 'error', true);
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    // Get stored code verifier
                    const codeVerifier = sessionStorage.getItem('code_verifier');
                    if (!codeVerifier) {
                        this.showMessage('Authentication session expired. Please start the login process again.', 'error', true);
                        this.clearCallbackUrl();
                        return;
                    }
                    
                    // Exchange code for tokens
                    await this.exchangeCodeForTokens(code, codeVerifier);
                    
                } catch (error) {
                    console.error('Callback handling error:', error);
                    this.showMessage(`Authentication processing failed: ${error.message}`, 'error', true);
                    this.showLoading(false);
                }
            }
            
            async exchangeCodeForTokens(code, codeVerifier) {
                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            client_id: CONFIG.CLIENT_ID,
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: CONFIG.AUTH_REDIRECT_URI,
                            code_verifier: codeVerifier
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        let errorMessage = 'Failed to complete authentication';
                        
                        switch (errorData.error) {
                            case 'invalid_grant':
                                errorMessage = 'Authorization code expired. Please try logging in again.';
                                break;
                            case 'invalid_client':
                                errorMessage = 'Application configuration error. Please contact support.';
                                break;
                            case 'invalid_request':
                                errorMessage = 'Authentication request was invalid. Please try again.';
                                break;
                            default:
                                errorMessage = errorData.error_description || `Authentication error: ${errorData.error || response.status}`;
                        }
                        
                        throw new Error(errorMessage);
                    }
                    
                    const tokens = await response.json();
                    
                    // Validate token response
                    if (!tokens.access_token) {
                        throw new Error('Invalid token response from Spotify');
                    }
                    
                    // Calculate expiration time
                    const expiresAt = Date.now() + (tokens.expires_in * 1000);
                    
                    // Store tokens securely
                    sessionStorage.setItem('access_token', tokens.access_token);
                    if (tokens.refresh_token) {
                        sessionStorage.setItem('refresh_token', tokens.refresh_token);
                    }
                    sessionStorage.setItem('expires_at', expiresAt.toString());
                    
                    // Generate bootstrap nonce for additional security
                    const bootstrapNonce = this.generateState();
                    sessionStorage.setItem('bootstrap_nonce', bootstrapNonce);
                    
                    // Clean up OAuth session data
                    sessionStorage.removeItem('code_verifier');
                    sessionStorage.removeItem('oauth_state');
                    
                    // Prepare navigation with preserved country
                    const country = sessionStorage.getItem('auth_country');
                    sessionStorage.removeItem('auth_country');
                    
                    let gameUrl = `${CONFIG.GAME_URL}?bootstrap=${bootstrapNonce}`;
                    if (country) {
                        gameUrl += `&country=${encodeURIComponent(country)}`;
                    }
                    
                    this.showMessage('Authentication successful! Redirecting to game...', 'success');
                    
                    // Navigate to game with a slight delay for user feedback
                    setTimeout(() => {
                        window.location.href = gameUrl;
                    }, 1500);
                    
                } catch (error) {
                    console.error('Token exchange error:', error);
                    this.showMessage(error.message || 'Failed to complete authentication', 'error', true);
                    this.clearSession();
                    this.showLoading(false);
                }
            }
            
            clearSession() {
                sessionStorage.removeItem('code_verifier');
                sessionStorage.removeItem('oauth_state');